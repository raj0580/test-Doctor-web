javascript
import { db } from '../assets/js/firebase-config.js';
import { collection, getDocs, addDoc, serverTimestamp, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// üî¥ ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£: ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ImgBB API Key ‡¶¶‡¶ø‡¶®
const IMGBB_API_KEY = '5090ec8c335078581b53f917f9657083';

const leadsContainer = document.getElementById('leads-container');
const ordersContainer = document.getElementById('orders-container');
const addProductForm = document.getElementById('add-product-form');
const addProductBtn = document.getElementById('add-product-btn');

// --- 1. Add Product with ImgBB ---
addProductForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    addProductBtn.disabled = true;
    addProductBtn.textContent = '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

    const imageFile = document.getElementById('product-image').files[0];
    if (!imageFile) return alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');

    const formData = new FormData();
    formData.append('image', imageFile);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
        const result = await response.json();

        if (!result.success) throw new Error('ImgBB-‡¶§‡ßá ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§');
        
        const imageUrl = result.data.url;
        const productData = {
            name: document.getElementById('product-name').value,
            description: document.getElementById('product-desc').value,
            mrp: Number(document.getElementById('product-mrp').value),
            sellingPrice: Number(document.getElementById('product-price').value),
            imageUrl: imageUrl,
            createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "products"), productData);
        alert('‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
        addProductForm.reset();

    } catch (error) {
        console.error('‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:', error);
        alert('‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ' + error.message);
    } finally {
        addProductBtn.disabled = false;
        addProductBtn.textContent = '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
    }
});

// --- 2. Load Leads ---
async function loadLeads() {
    const q = query(collection(db, "leads"), orderBy("timestamp", "desc"));
    const leadSnapshot = await getDocs(q);
    let html = '<table class="data-table"><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶´‡ßã‡¶®</th><th>‡¶∏‡¶Æ‡ßü</th></tr>';
    leadSnapshot.forEach(doc => {
        const lead = doc.data();
        const date = new Date(lead.timestamp.seconds * 1000).toLocaleString("bn-BD");
        html += `<tr><td>${lead.name}</td><td>${lead.phone}</td><td>${date}</td></tr>`;
    });
    html += '</table>';
    leadsContainer.innerHTML = html;
}

// --- 3. Load Orders ---
async function loadOrders() {
    const q = query(collection(db, "orders"), orderBy("orderDate", "desc"));
    const orderSnapshot = await getDocs(q);
    let html = '<table class="data-table"><tr><th>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th><th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</th><th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>';
    orderSnapshot.forEach(doc => {
        const order = doc.data();
        html += `
            <tr>
                <td>${doc.id}</td>
                <td>${order.customerInfo.name} <br> ${order.customerInfo.phone}</td>
                <td>${order.status}</td>
                <td>
                    <select class="order-status-select" data-id="${doc.id}">
                        <option value="Placed" ${order.status === 'Placed' ? 'selected' : ''}>Placed</option>
                        <option value="Dispatched" ${order.status === 'Dispatched' ? 'selected' : ''}>Dispatched</option>
                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </td>
            </tr>
        `;
    });
    html += '</table>';
    ordersContainer.innerHTML = html;

    document.querySelectorAll('.order-status-select').forEach(select => {
        select.addEventListener('change', updateOrderStatus);
    });
}

// --- 4. Update Order Status ---
async function updateOrderStatus(e) {
    const orderId = e.target.dataset.id;
    const newStatus = e.target.value;
    
    try {
        const orderRef = doc(db, "orders", orderId);
        await updateDoc(orderRef, { status: newStatus });
        alert(`‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    } catch (error) {
        console.error("‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error);
    }
}

// Initial Data Load
loadLeads();
loadOrders();
